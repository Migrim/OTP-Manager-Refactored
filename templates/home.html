{% extends 'base.html' %}

{% block title %}Home | OTP-Tool{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/home.css') }}">
<style>
    .otp-card-inner {
        transition: filter 0.3s ease, opacity 0.3s ease;
    }
    .otp-card.inactive-blur .otp-card-inner {
        filter: blur(6px);
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="otp-wrapper">
    <div id="otpContainer"></div>
</div>

<a id="backToTop" href="#" title="Back to top">
    <i class="fas fa-arrow-up"></i>
</a>

<div id="confirmDeleteOtpModal" class="add-user-modal">
    <div class="add-user-modal-content" style="width: 360px;">
        <span class="add-user-close" id="closeDeleteOtpModal">&times;</span>
        <form method="post" action="/api/delete-secret" id="deleteOtpForm">
            <input type="hidden" name="secret_id" id="delete-secret-id">
            <p style="margin-bottom: 1rem;">Are you sure you want to delete this OTP entry?</p>
            <div class="delete-user-button-row">
                <button type="submit" class="confirm-delete-button">Yes, Delete</button>
                <button type="button" id="cancelDeleteOtp" style="margin-left:8px; padding:0.6rem 1.2rem; border-radius:8px; border:none; cursor:pointer;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="editOtpModal" class="add-user-modal">
    <div class="add-user-modal-content" style="max-width: 480px;">
        <span class="add-user-close" id="closeEditOtpModal">&times;</span>
        <form id="editOtpForm" class="add-user-form">
            <input type="hidden" name="secret_id" id="edit-secret-id">
            <label for="edit-name">Name</label>
            <div class="add-user-input-wrapper">
                <input type="text" id="edit-name" name="name" placeholder="Name" required>
            </div>

            <label for="edit-email">E-Mail</label>
            <div class="add-user-input-wrapper">
                <input type="email" id="edit-email" name="email" placeholder="email@example.com">
            </div>

            <label for="edit-secret">Secret</label>
            <div class="add-user-input-wrapper">
                <input type="text" id="edit-secret" name="secret" placeholder="Base32 secret" required>
            </div>

            <label for="edit-refresh-time">Refresh Time (seconds)</label>
            <div class="add-user-input-wrapper">
                <input type="number" id="edit-refresh-time" name="refresh_time" min="10" placeholder="30" required readonly>
            </div>

            <label for="edit-company">Company</label>
            <div class="add-user-input-wrapper">
                <select id="edit-company" name="company_id" required></select>
            </div>

            <div class="add-user-button-row">
                <button type="submit">Save Changes</button>
                <button type="button" id="cancelEditOtp" style="margin-left:8px; padding:0.6rem 1.2rem; border-radius:8px; border:none; cursor:pointer;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    const SHOW_EMAIL = {{ 1 if user_settings.show_emails else 0 }};
    const SHOW_TEXT_TIMER = {{ 1 if user_settings.show_timer else 0 }};
    const blur_on_inactive = {{ 1 if user_settings.blur_on_inactive else 0 }};
    const SHOW_INCLUDE_ADMIN_ON_TOP = {{ 1 if user_settings.show_including_admin_on_top else 0 }};
    const visibleCards = new Set();
    let companyOptionsCache = null;
    let lastSlot = null;
    let lastActivity = Date.now();
    let blurApplied = false;

    function maskSecret(s) {
        const n = typeof s === 'string' ? s.length : 0;
        return '*'.repeat(Math.min(n, 16));
    }

    function debounce(func, delay) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), delay);
        };
    }

    function sortSecretsForDisplay(list) {
        if (!Array.isArray(list)) return [];
        if (!SHOW_INCLUDE_ADMIN_ON_TOP) {
            return list.sort((a, b) => {
                const aName = typeof a.name === "string" ? a.name : "";
                const bName = typeof b.name === "string" ? b.name : "";
                return aName.localeCompare(bName);
            });
        }
        return list.sort((a, b) => {
            const aName = typeof a.name === "string" ? a.name : "";
            const bName = typeof b.name === "string" ? b.name : "";
            const aAdmin = aName.toLowerCase().includes("admin");
            const bAdmin = bName.toLowerCase().includes("admin");
            if (aAdmin && !bAdmin) return -1;
            if (!aAdmin && bAdmin) return 1;
            return aName.localeCompare(bName);
        });
    }

    function markActivity() {
        lastActivity = Date.now();
        if (blurApplied) {
            blurApplied = false;
            document.querySelectorAll('.otp-card').forEach(card => {
                card.classList.remove('inactive-blur');
            });
        }
    }

    function applyBlurIfNeeded() {
        if (!blur_on_inactive || !blurApplied) return;
        document.querySelectorAll('.otp-card').forEach(card => {
            card.classList.add('inactive-blur');
        });
    }

    async function refreshCardCode(card){
        try{
            const id = String(card.dataset.id);
            const res = await fetch(`/api/secrets/${id}`);
            if(!res.ok) return;
            const data = await res.json();
            const codeEl = card.querySelector('.otp-code');
            const next = String(data.current_code || "");
            if(codeEl && codeEl.textContent.trim() !== next) animateCodeChange(codeEl, next);
        }catch(e){}
    }

    async function fetchCompanyOptions() {
        if (companyOptionsCache) return companyOptionsCache;
        const res = await fetch('/api/secrets');
        const secrets = await res.json();
        const map = {};
        secrets.forEach(s => {
            if (s.company_id != null) map[s.company_id] = s.company_name || "Unknown Company";
        });
        companyOptionsCache = Object.entries(map)
            .sort((a, b) => a[1].localeCompare(b[1]))
            .map(([id, name]) => ({ id, name }));
        return companyOptionsCache;
    }

    function animateCodeChange(el, next) {
        const n = String(next || '');
        el.innerHTML = '';
        for (let i = 0; i < n.length; i++) {
            const s = document.createElement('span');
            s.className = 'digit';
            s.style.animationDelay = (i * 25) + 'ms';
            s.textContent = n[i];
            el.appendChild(s);
        }
    }

    function populateCompanySelect(selectEl, selectedId) {
        fetchCompanyOptions().then(options => {
            selectEl.innerHTML = '';
            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt.id;
                o.textContent = opt.name;
                if (String(opt.id) === String(selectedId)) o.selected = true;
                selectEl.appendChild(o);
            });
        });
    }

    const searchOtpInput = document.getElementById("search-otp-input");
    if (searchOtpInput) {
        const filterFn = (q) => {
            const sections = document.querySelectorAll(".otp-section");
            sections.forEach(section => {
                let visibleCount = 0;
                const cards = section.querySelectorAll(".otp-card");
                cards.forEach(card => {
                    const text = card.dataset.search || "";
                    const match = text.includes(q);
                    card.style.display = match ? "block" : "none";
                    if (match) visibleCount++;
                });
                section.style.display = visibleCount > 0 ? "block" : "none";
            });
        };
        searchOtpInput.addEventListener("input", e => filterFn(e.target.value.toLowerCase().trim()));
        searchOtpInput.addEventListener("input", debounce(e => filterFn(e.target.value.toLowerCase().trim()), 100));
    }

    function copyText(t) {
        if (window.isSecureContext && navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(t);
        }
        return new Promise((resolve, reject) => {
            const el = document.createElement('textarea');
            el.value = t;
            el.setAttribute('readonly', '');
            el.style.position = 'fixed';
            el.style.opacity = '0';
            document.body.appendChild(el);
            el.select();
            try {
                document.execCommand('copy') ? resolve() : reject();
            } catch (e) {
                reject(e);
            }
            document.body.removeChild(el);
        });
    }

    function setupCard(card) {
        const secretEl = card.querySelector('.otp-secret');
        if (!secretEl) return;
        const pinIcon = card.querySelector(".pin-icon");
        const codeText = card.querySelector('.otp-code');
        const copyButton = card.querySelector('.action-button.copy');
        const timerEl = SHOW_TEXT_TIMER ? card.querySelector('.otp-timer') : null;
        const circle = SHOW_TEXT_TIMER ? null : card.querySelector('.countdown-circle .circle-fg');
        card._lastSlot = null;

        animateCodeChange(codeText, codeText.textContent.trim());

        copyButton.addEventListener('click', () => {
            const code = codeText.textContent.trim();
            if (!code) return;
            copyText(code).then(() => { alert(`Copied code: ${code}`); }).catch(() => { window.prompt('Copy code:', code); });
        });

        pinIcon.addEventListener("click", async () => {
            const secretId = card.dataset.id;
            const res = await fetch("/toggle-pin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ secret_id: secretId })
            });
            if (res.ok) {
            const { pinned } = await res.json();
            pinIcon.classList.toggle("pinned", pinned);
            loadOTPs();
            }
        });

        card._updateTimer = function (remaining, currentSlot) {
            if (SHOW_TEXT_TIMER && timerEl) {
                timerEl.textContent = String(remaining);
            } else if (circle) {
                const percent = (remaining / 30) * 100;
                circle.style.strokeDashoffset = 100 - percent;
            }
            card._lastSlot = currentSlot;
        };

        secretEl.addEventListener('mouseenter', () => { secretEl.classList.add('reveal') });
        secretEl.addEventListener('mouseleave', () => { secretEl.classList.remove('reveal') });

        const now = Math.floor(Date.now() / 1000);
        const remaining = 30 - (now % 30);
        const slot = Math.floor(now / 30);
        card._updateTimer(remaining, slot);
    }

    async function refreshVisibleCodes() {
        const res = await fetch('/api/secrets');
        const list = await res.json();
        const map = new Map(list.map(s => [String(s.id), String(s.current_code || "")]));
        visibleCards.forEach(card => {
            const id = String(card.dataset.id);
            const codeEl = card.querySelector('.otp-code');
            if (!codeEl || !map.has(id)) return;
            const next = map.get(id);
            const current = codeEl.textContent.trim();
            if (current !== next) animateCodeChange(codeEl, next);
        });
    }

    async function loadOTPs() {
        const res = await fetch('/api/secrets');
        const secrets = await res.json();
        const pinnedRes = await fetch('/api/user-pinned');
        const pinnedIds = await pinnedRes.json();

        const grouped = {};
        secrets.forEach(otp => {
            const company = otp.company_name || "Unknown Company";
            if (!grouped[company]) grouped[company] = [];
            grouped[company].push(otp);
        });

        const container = document.getElementById("otpContainer");
        container.innerHTML = "";

        const pinned = secrets.filter(s => pinnedIds.includes(String(s.id)));
        if (pinned.length > 0) {
            const pinnedSection = document.createElement("div");
            pinnedSection.className = "otp-section";

            const title = document.createElement("h2");
            title.className = "company-title";
            title.textContent = "Your Pinned OTPs";

            const grid = document.createElement("div");
            grid.className = "otp-grid";

            for (const entry of sortSecretsForDisplay(pinned)) {
                const card = document.createElement("div");
                const delay = Math.floor(Math.random() * 120) + 30;
                card.className = "otp-card";
                card.style.animationDelay = `${delay}ms`;
                card.dataset.id = entry.id;
                card.dataset.search = `${entry.name} ${entry.email} ${entry.secret}`.toLowerCase();

                card.innerHTML = `
                    <div class="otp-card-inner">
                        <span class="pin-icon pinned"><span class="material-icons">push_pin</span></span>
                        <div class="otp-field"><span class="otp-field-label">Name:</span> <span class="otp-field-value">${entry.name}</span></div>
                        <div class="otp-field"><span class="otp-field-label">Secret:</span> 
                            ${(() => {
                                const m = maskSecret(entry.secret);
                                return `<span class="otp-field-value otp-secret" data-real="${entry.secret}" data-hidden="${m}">${m}</span>`;
                            })()}
                        </div>
                        <div class="otp-field"><span class="otp-field-label">OTP Code:</span> <span class="otp-field-value code-text otp-code">${entry.current_code || ""}</span></div>
                        ${SHOW_EMAIL ? `
                            <div class="otp-field">
                                <span class="otp-field-label">E-Mail:</span>
                                <span class="otp-field-value">${entry.email}</span>
                            </div>
                        ` : ``}
                        ${SHOW_TEXT_TIMER ? `
                            <div class="otp-field"><span class="otp-field-label">Remaining Time:</span> <span class="otp-field-value otp-timer"></span></div>
                        ` : ``}
                        <div class="otp-actions">
                            <button class="action-button copy" title="Copy"><span class="material-icons">content_copy</span></button>
                            <button class="action-button edit" title="Edit"><span class="material-icons">edit</span></button>
                            <button class="action-button delete" title="Delete"><span class="material-icons">delete</span></button>
                            ${SHOW_TEXT_TIMER ? `` : `
                                <svg class="countdown-circle" width="26" height="26" viewBox="0 0 36 36">
                                    <circle class="circle-bg" cx="18" cy="18" r="16"></circle>
                                    <circle class="circle-fg" cx="18" cy="18" r="16"></circle>
                                </svg>
                            `}
                        </div>
                    </div>
                `;
                setupCard(card);
                grid.appendChild(card);
            }

            pinnedSection.appendChild(title);
            pinnedSection.appendChild(grid);
            container.appendChild(pinnedSection);
        }

        for (const company of Object.keys(grouped).sort()) {
            const section = document.createElement("div");
            section.className = "otp-section";

            const title = document.createElement("h2");
            title.className = "company-title";
            title.textContent = company;

            const grid = document.createElement("div");
            grid.className = "otp-grid";

            for (const entry of sortSecretsForDisplay(grouped[company])) {
                if (pinnedIds.includes(String(entry.id))) continue;

                const card = document.createElement("div");
                const delay = Math.floor(Math.random() * 120) + 30;
                card.className = "otp-card";
                card.style.animationDelay = `${delay}ms`;
                card.dataset.id = entry.id;
                card.dataset.search = `${entry.name} ${entry.email} ${entry.secret} ${company}`.toLowerCase();

                card.innerHTML = `
                    <div class="otp-card-inner">
                        <span class="pin-icon"><span class="material-icons">push_pin</span></span>
                        <div class="otp-field"><span class="otp-field-label">Name:</span> <span class="otp-field-value">${entry.name}</span></div>
                        <div class="otp-field"><span class="otp-field-label">Secret:</span> 
                            ${(() => {
                                const m = maskSecret(entry.secret);
                                return `<span class="otp-field-value otp-secret" data-real="${entry.secret}" data-hidden="${m}">${m}</span>`;
                            })()}
                        </div>
                        <div class="otp-field"><span class="otp-field-label">OTP Code:</span> <span class="otp-field-value code-text otp-code">${entry.current_code || ""}</span></div>
                        ${SHOW_EMAIL ? `
                            <div class="otp-field">
                                <span class="otp-field-label">E-Mail:</span>
                                <span class="otp-field-value">${entry.email}</span>
                            </div>
                        ` : ``}
                        ${SHOW_TEXT_TIMER ? `
                            <div class="otp-field"><span class="otp-field-label">Remaining Time:</span> <span class="otp-field-value otp-timer"></span></div>
                        ` : ``}
                        <div class="otp-actions">
                            <button class="action-button copy" title="Copy"><span class="material-icons">content_copy</span></button>
                            <button class="action-button edit" title="Edit"><span class="material-icons">edit</span></button>
                            <button class="action-button delete" title="Delete"><span class="material-icons">delete</span></button>
                            ${SHOW_TEXT_TIMER ? `` : `
                                <svg class="countdown-circle" width="26" height="26" viewBox="0 0 36 36">
                                    <circle class="circle-bg" cx="18" cy="18" r="16"></circle>
                                    <circle class="circle-fg" cx="18" cy="18" r="16"></circle>
                                </svg>
                            `}
                        </div>
                    </div>
                `;
                setupCard(card);
                grid.appendChild(card);
            }

            section.appendChild(title);
            section.appendChild(grid);
            container.appendChild(section);
        }

        if (!container.querySelector('.otp-card')) {
            const empty = document.createElement('div');
            empty.className = 'otp-empty-state';
            empty.innerHTML = `
                <span class="material-symbols-outlined otp-empty-icon">key_off</span>
                <div class="otp-empty-text">No OTPs stored</div>
            `;
            container.appendChild(empty);
        }

        setupObserver();
        startGlobalUpdater();
        attachDeleteHandlers();
        attachEditHandlers();
        applyBlurIfNeeded();
    }

    function setupObserver() {
        const observer = new IntersectionObserver(entries => {
            for (const entry of entries) {
            const card = entry.target;
            if (entry.isIntersecting) {
                visibleCards.add(card);
                refreshCardCode(card);
            } else {
                visibleCards.delete(card);
            }
            }
        }, { root: null, threshold: 0.1 });
        document.querySelectorAll('.otp-card').forEach(card => observer.observe(card));
    }

    function startGlobalUpdater() {
        setInterval(async () => {
            const now = Math.floor(Date.now() / 1000);
            const currentSlot = Math.floor(now / 30);
            const remaining = 30 - (now % 30);

            visibleCards.forEach(card => {
                if (card._updateTimer) card._updateTimer(remaining, currentSlot);
            });

            if (currentSlot !== lastSlot) {
                lastSlot = currentSlot;
                await refreshVisibleCodes();
            }
        }, 1000);
    }

    function attachDeleteHandlers() {
        document.querySelectorAll('.otp-card .action-button.delete').forEach(btn => {
            btn.onclick = (e) => {
                const card = e.currentTarget.closest(".otp-card");
                const secretId = card.dataset.id;
                document.getElementById("delete-secret-id").value = secretId;
                document.getElementById("confirmDeleteOtpModal").style.display = "flex";
            };
        });
    }

    function attachEditHandlers() {
        document.querySelectorAll('.otp-card .action-button.edit').forEach(btn => {
            btn.onclick = async (e) => {
                const card = e.currentTarget.closest(".otp-card");
                const secretId = card.dataset.id;

                const res = await fetch('/api/secrets');
                const list = await res.json();
                const entry = list.find(s => String(s.id) === String(secretId)) || {};

                document.getElementById("edit-secret-id").value = secretId;
                document.getElementById("edit-name").value = entry.name || "";
                document.getElementById("edit-email").value = entry.email || "";
                document.getElementById("edit-secret").value = entry.secret || "";
                document.getElementById("edit-refresh-time").value = entry.refresh_time || 30;
                populateCompanySelect(document.getElementById("edit-company"), entry.company_id);

                document.getElementById("editOtpModal").style.display = "flex";
            };
        });
    }

    document.getElementById("deleteOtpForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        const formData = new FormData(form);
        const res = await fetch(form.action, { method: "POST", body: formData });
        if (res.ok) {
            document.getElementById("confirmDeleteOtpModal").style.display = "none";
            loadOTPs();
        } else {
            alert('Failed to delete OTP.');
        }
    });

    document.getElementById("closeDeleteOtpModal").onclick = () => {
        document.getElementById("confirmDeleteOtpModal").style.display = "none";
    };
    document.getElementById("cancelDeleteOtp").onclick = () => {
        document.getElementById("confirmDeleteOtpModal").style.display = "none";
    };
    window.addEventListener("click", (e) => {
        if (e.target.id === "confirmDeleteOtpModal") {
            document.getElementById("confirmDeleteOtpModal").style.display = "none";
        }
    });

    document.getElementById("closeEditOtpModal").onclick = () => {
        document.getElementById("editOtpModal").style.display = "none";
    };
    document.getElementById("cancelEditOtp").onclick = () => {
        document.getElementById("editOtpModal").style.display = "none";
    };
    window.addEventListener("click", (e) => {
        if (e.target.id === "editOtpModal") {
            document.getElementById("editOtpModal").style.display = "none";
        }
    });

    document.getElementById("editOtpForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const secretId = document.getElementById("edit-secret-id").value;
        const payload = {
            name: document.getElementById("edit-name").value,
            email: document.getElementById("edit-email").value || "none",
            secret: document.getElementById("edit-secret").value,
            refresh_time: parseInt(document.getElementById("edit-refresh-time").value) || 30,
            otp_type: "totp",
            company_id: parseInt(document.getElementById("edit-company").value) || 1
        };
        const res = await fetch(`/api/secrets/${secretId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            document.getElementById("editOtpModal").style.display = "none";
            await loadOTPs();
        } else {
            const err = await res.json();
            alert("Failed to update OTP: " + (err.error || "unknown error"));
        }
    });

    loadOTPs();

    const backToTop = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 200) {
            backToTop.classList.add('visible');
        } else {
            backToTop.classList.remove('visible');
        }
    });
    backToTop.addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    if (blur_on_inactive) {
        ['mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
            window.addEventListener(evt, markActivity, { passive: true });
        });
        setInterval(() => {
            if (!blur_on_inactive) return;
            const now = Date.now();
            if (!blurApplied && now - lastActivity >= 60000) {
                blurApplied = true;
                applyBlurIfNeeded();
                alert("You were inactive for a while, your OTPs are temporarily blurred.");
            }
        }, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.body.classList.add("home");
    });
</script>
{% endblock %}