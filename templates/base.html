<!DOCTYPE html>
<html lang="en" class="{{ 'dark-mode' if request.cookies.get('theme') == 'dark' else '' }} preload">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}One-Auth - OTP Tool{% endblock %}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="{{ url_for('static', filename='java-script/search.js') }}"></script>
    <script src="{{ url_for('static', filename='java-script/drop.js') }}"></script>
    <script>
        (function () {
            try {
                document.documentElement.classList.add('preload');
            } catch (e) {}
        })();
    </script>
    {% block head %}{% endblock %}
</head>

{% if is_logged_in %}

<div id="search-modal" class="search-modal">
    <div class="search-input-container">
        <span class="material-symbols-outlined search-icon">search</span>
        <input type="text" placeholder="Search" id="search-field" autofocus>
        <span class="esc-label">Esc</span>
        <ul id="search-suggestions" class="search-suggestions hidden"></ul>
    </div>
</div>
{% endif %}

<div id="toast-container"></div>
    
    <header class="navbar">
        <div class="navbar-left">
            <a href="/" class="logo">
                <img src="{{ url_for('static', filename='favicon.ico') }}" alt="icon" width="16" height="16">
                <span>OTP-Tool</span>
            </a>
    
            {% if is_logged_in %}
                <a href="/" class="docs-link">Home</a>
                <a href="/add" class="docs-link">Add</a>
                {% if is_admin %}
                <a href="/users" class="docs-link">Users</a>
                <a href="/companies" class="docs-link">Companies</a>
                {% endif %}
                <a href="/settings" class="docs-link">Settings</a>
            {% endif %}
        </div>
    
        <div class="navbar-right">
            {% if is_logged_in %}
                <div class="search-box" id="company-dropdown-container">
                    <div class="select-wrapper">
                        <select id="companyDropdown" aria-label="Select company">
                            <option value="" class="placeholder-option">Select Company...</option>
                        </select>
                    </div>
                </div>
                
                <div class="search-box-otp" id="search-otp-container">
                    <div id="search-otp-fake" class="otp-search-placeholder-text">Search</div>
                    <input type="text" id="search-otp-input" class="otp-search-input" placeholder="Search..." autocomplete="off" />
                    <div class="shortcut">âŒ˜ K</div>
                </div>
            {% endif %}
            <button class="theme-toggle"><i class="fa-solid fa-moon"></i></button>
            {% if is_logged_in %}
                <a href="/logout" class="logout-link">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                </a>
            {% endif %}
        </div>
    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <div class="footer-left">
            <span>&copy; 2025 One-Auth.net</span>
            <a href="https://one-auth.net/privacy-policy">Privacy</a>
        </div>
        <div class="footer-right">
            <a href="/logs"><i class="fa-regular fa-lemon"></i></a>
            <a href="https://github.com/Migrim"><i class="fa-brands fa-github"></i></a>
        </div>
    </footer>

    <script>
        const body = document.body;
        const icon = document.querySelector(".theme-toggle i");
    
        if (document.documentElement.classList.contains("dark-mode")) {
            icon.classList.remove("fa-moon");
            icon.classList.add("fa-sun");
            body.classList.add("dark-mode"); 
        }
    
        document.querySelector(".theme-toggle").addEventListener("click", () => {
            const isDark = document.documentElement.classList.toggle("dark-mode");
            document.body.classList.toggle("dark-mode", isDark);

            localStorage.setItem("theme", isDark ? "dark" : "light");
            document.cookie = `theme=${isDark ? 'dark' : 'light'}; path=/; max-age=31536000`;

            icon.classList.toggle("fa-moon", !isDark);
            icon.classList.toggle("fa-sun", isDark);
        });

        window.addEventListener('load', () => {
            document.documentElement.classList.remove('preload');
            document.documentElement.classList.remove('dark-mode-preload');
        });

        function showToast(message, type = "info") {
            const container = document.getElementById("toast-container");
            const toast = document.createElement("div");
            toast.className = `toast-message ${type}`;

            const icon = document.createElement("span");
            icon.className = "material-symbols-outlined toast-icon";
            switch (type) {
                case "success": icon.textContent = "check_circle"; break;
                case "error": icon.textContent = "error"; break;
                case "warning": icon.textContent = "warning"; break;
                default: icon.textContent = "info";
            }

            const text = document.createElement("span");
            text.className = "toast-text";
            text.textContent = message;

            const close = document.createElement("button");
            close.className = "toast-close";
            close.innerHTML = "&times;";
            close.onclick = () => {
                toast.classList.remove("visible");
                toast.classList.add("hide");
                toast.style.marginBottom = "-50px";
                setTimeout(() => toast.remove(), 450);
            };

            toast.appendChild(icon);
            toast.appendChild(text);
            toast.appendChild(close);
            container.appendChild(toast);

            setTimeout(() => toast.classList.add("visible"), 10);


            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove("visible");
                    toast.classList.add("hide");
                    toast.style.marginBottom = "-50px";
                    setTimeout(() => toast.remove(), 450);
                }
            }, 5000);
        }

        window.alert = function(msg) {
            showToast(msg, "info");
        };

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
                showToast({{ message|tojson }}, "{{ category }}");
            {% endfor %}
        {% endwith %}

        const searchModal = document.getElementById('search-modal');
        const searchInput = document.getElementById('search-field');

        function openSearchModal() {
            searchModal.classList.add('active');
            setTimeout(() => searchInput.focus(), 50);
        }

        function closeSearchModal() {
            searchModal.classList.remove('active');
        }

        document.addEventListener('keydown', (e) => {
            const activeElement = document.activeElement;

            if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k' && activeElement.id !== 'companySearchInput') {
                e.preventDefault();
                openSearchModal();
            }

            if (searchModal.classList.contains('active') && e.key === 'Escape') {
                e.preventDefault();
                closeSearchModal();
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const fakeSearch = document.getElementById("search-otp-fake");
            if (fakeSearch) {
                fakeSearch.addEventListener("click", () => {
                    if (!document.body.classList.contains("home")) {
                        openSearchModal();
                    }
                });
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const searchOtpInput = document.getElementById("search-otp-input");
            if (searchOtpInput) {
                searchOtpInput.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" && searchOtpInput.value.trim() !== "") {
                        e.preventDefault();
                        const term = encodeURIComponent(searchOtpInput.value.trim());
                        window.location.href = `/search.html?q=${term}`;
                    }
                });
            }
        });

    </script>
</body>
</html>