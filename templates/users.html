{% extends "base.html" %}

{% block title %}Users | OTP-Tool{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/users.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="user-grid">
    {% if users|length == 0 %}
        <div class="users-empty-state">
            <span class="material-symbols-outlined users-empty-icon">group_off</span>
            <div class="users-empty-text">No users stored</div>
        </div>
    {% else %}
        {% for id, username, is_admin in users %}
        {% set delay = range(30, 150)|random %}
        <div class="user-card" data-user-id="{{ id }}" style="animation-delay: {{ delay }}ms;">
            <div class="user-name">{{ username }}</div>
            <div class="user-status">
                {{ "is Administrator" if is_admin else "is not Administrator" }}
            </div>
            <div class="user-actions">
                <button class="action-button copy" title="Reset Password">
                    <span class="material-icons">lock_reset</span>
                </button>
                <form method="post" action="/api/toggle-admin">
                    <input type="hidden" name="user_id" value="{{ id }}">
                    <button class="action-button edit" title="Toggle Admin">
                        <span class="material-icons">{{ "admin_panel_settings" if is_admin else "person_add" }}</span>
                    </button>
                </form>
                <button class="action-button delete" title="Delete User">
                    <span class="material-icons">delete</span>
                </button>
            </div>
        </div>
        {% endfor %}
    {% endif %}
</div>

<a href="#" class="fab-add-user" id="openAddUserModal" title="Add User">
    <span class="material-icons">add</span>
</a>

<div id="addUserModal" class="add-user-modal">
    <div class="add-user-modal-content">
        <span class="add-user-close" id="closeAddUserModal">&times;</span>
        <form class="add-user-form" method="post" action="/api/create-user">
            <label for="username">Username</label>
            <div class="add-user-input-wrapper">
                <input type="text" id="username" name="username" placeholder="e.g. johndoe" required>
            </div>

            <label for="password">Password</label>
            <div class="add-user-input-wrapper" style="position: relative;">
                <input type="password" id="add_password" name="password" placeholder="Enter new password" required>
                <span id="toggleAddPassword" class="material-symbols-outlined" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; color: #777;">
                    visibility_off
                </span>
            </div>

            <label class="add-user-checkbox">
                <input type="checkbox" name="is_admin">
                Administrator
            </label>

            <div class="add-user-button-row">
                <button type="submit">Add User</button>
            </div>
        </form>
    </div>
</div>

<div id="resetPasswordModal" class="add-user-modal">
    <div class="add-user-modal-content">
        <span class="add-user-close" id="closeResetPasswordModal">&times;</span>
        <form class="add-user-form" method="post" action="/api/reset-password" id="resetPasswordForm">
            <input type="hidden" id="reset-user-id" name="user_id">

            <label for="new_password">New Password</label>
            <div class="add-user-input-wrapper" style="position: relative;">
                <input type="password" id="reset_password" name="new_password" placeholder="Enter new password" required>
                <span id="toggleResetPassword" class="material-symbols-outlined" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; color: #777;">
                    visibility_off
                </span>
            </div>

            <div class="add-user-button-row">
                <button type="submit">Reset Password</button>
            </div>
        </form>
    </div>
</div>

<div id="confirmDeleteModal" class="add-user-modal">
    <div class="add-user-modal-content">
        <span class="add-user-close" id="closeDeleteModal">&times;</span>
        <form method="post" action="/api/delete-user" id="deleteUserForm">
            <input type="hidden" name="user_id" id="delete-user-id">
            <p style="margin-bottom: 1rem;">Are you sure you want to delete this user?</p>
            <div class="delete-user-button-row">
                <button type="submit" class="confirm-delete-button">Yes, Delete</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById("openAddUserModal").onclick = () => {
        document.getElementById("addUserModal").style.display = "flex";
    };
    document.getElementById("closeAddUserModal").onclick = () => {
        document.getElementById("addUserModal").style.display = "none";
    };
    window.onclick = (e) => {
        if (e.target.id === "addUserModal") {
            document.getElementById("addUserModal").style.display = "none";
        }
    };

    document.querySelectorAll(".action-button.copy").forEach(btn => {
        btn.onclick = (e) => {
            const userCard = e.currentTarget.closest(".user-card");
            const userId = userCard.dataset.userId;
            document.getElementById("reset-user-id").value = userId;
            document.getElementById("resetPasswordModal").style.display = "flex";
        };
    });

    document.getElementById("closeResetPasswordModal").onclick = () => {
        document.getElementById("resetPasswordModal").style.display = "none";
    };

    window.addEventListener("click", (e) => {
        if (e.target.id === "resetPasswordModal") {
            document.getElementById("resetPasswordModal").style.display = "none";
        }
    });
    document.getElementById("toggleResetPassword").addEventListener("click", () => {
        const input = document.getElementById("reset_password");
        const icon = document.getElementById("toggleResetPassword");
        const isVisible = input.type === "text";
        input.type = isVisible ? "password" : "text";
        icon.textContent = isVisible ? "visibility_off" : "visibility";
    });
    document.getElementById("toggleAddPassword").addEventListener("click", () => {
        const input = document.getElementById("add_password");
        const icon = document.getElementById("toggleAddPassword");
        const isVisible = input.type === "text";
        input.type = isVisible ? "password" : "text";
        icon.textContent = isVisible ? "visibility_off" : "visibility";
    });

    document.querySelectorAll(".action-button.delete").forEach(btn => {
        btn.onclick = (e) => {
            const userCard = e.currentTarget.closest(".user-card");
            const userId = userCard.dataset.userId;
            document.getElementById("delete-user-id").value = userId;
            document.getElementById("confirmDeleteModal").style.display = "flex";
        };
    });

    document.getElementById("closeDeleteModal").onclick = () => {
        document.getElementById("confirmDeleteModal").style.display = "none";
    };

    window.addEventListener("click", (e) => {
        if (e.target.id === "confirmDeleteModal") {
            document.getElementById("confirmDeleteModal").style.display = "none";
        }
    });
</script>

{% endblock %}